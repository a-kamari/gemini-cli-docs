name: Update Gemini CLI Documentation

on:
  schedule:
    # Run every 6 hours (at 00:00, 06:00, 12:00, 18:00 UTC)
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger
  push:
    branches: [main]
    paths:
      - 'scripts/**'

permissions:
  contents: write
  issues: write

jobs:
  update-docs:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt

    - name: Fetch latest documentation
      id: fetch-docs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
      run: |
        python scripts/fetch_gemini_docs.py || echo "fetch_failed=true" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Check for changes
      id: verify-changed-files
      run: |
        git diff --exit-code || echo "changed=true" >> $GITHUB_OUTPUT

    - name: Generate commit message
      if: steps.verify-changed-files.outputs.changed == 'true'
      id: commit-msg
      run: |
        git add -A docs/

        CHANGED_FILES=$(git diff --name-status --cached | grep "^M" | cut -f2 | grep -E "\.md$" | sed 's/docs\///' | paste -sd ", " -)
        ADDED_FILES=$(git diff --name-status --cached | grep "^A" | cut -f2 | grep -E "\.md$" | sed 's/docs\///' | paste -sd ", " -)
        DELETED_FILES=$(git diff --name-status --cached | grep "^D" | cut -f2 | grep -E "\.md$" | sed 's/docs\///' | paste -sd ", " -)

        COMMIT_MSG="Update Gemini CLI docs - $(date +'%Y-%m-%d')"

        if [ -n "$CHANGED_FILES" ]; then
          COMMIT_MSG="$COMMIT_MSG | Updated: $CHANGED_FILES"
        fi

        if [ -n "$ADDED_FILES" ]; then
          COMMIT_MSG="$COMMIT_MSG | Added: $ADDED_FILES"
        fi

        if [ -n "$DELETED_FILES" ]; then
          COMMIT_MSG="$COMMIT_MSG | Removed: $DELETED_FILES"
        fi

        echo "message=$COMMIT_MSG" >> $GITHUB_OUTPUT

    - name: Commit and push if changed
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git commit -m "${{ steps.commit-msg.outputs.message }}"
        git push

    - name: Create issue on failure
      if: steps.fetch-docs.outputs.fetch_failed == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const date = new Date().toISOString().split('T')[0];

          // Check for existing open issues
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'automation,bug'
          });

          const hasOpenIssue = issues.data.some(i =>
            i.title.includes('Documentation update failed')
          );

          if (!hasOpenIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Documentation update failed - ${date}`,
              body: `The automated documentation update failed on ${date}.\n\n` +
                    `**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}\n\n` +
                    `**Possible causes:**\n` +
                    `- GitHub API rate limiting\n` +
                    `- Source repository structure changed\n` +
                    `- Network connectivity issues\n\n` +
                    `Please investigate and manually trigger if needed.`,
              labels: ['bug', 'automation']
            });
          }
